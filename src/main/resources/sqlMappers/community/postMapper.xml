<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="postMapper">
<!--    <sql id="postColumns">-->
<!--        -->
<!--    </sql>-->
    <resultMap id="postSelectMap" type="com.example.demo.community.vo.PostVO">
        <result property="postNo" column="post_no"  jdbcType="NUMERIC"/>
        <result property="postName"     column="post_name"      jdbcType="VARCHAR"/>
        <result property="postContent"      column="post_content"       jdbcType="VARCHAR"/>
        <result property="userId"       column="user_id"        jdbcType="VARCHAR"/>
        <result property="regDate"      column="reg_date"       jdbcType="DATE"/>
        <result property="replyCnt"     column="reply_cnt"      jdbcType="NUMERIC"/>
<!--        <result property=""-->
        <result property="viewCnt"      column="view_cnt"       jdbcType="NUMERIC"/>


    <collection property="postReply" column="post_no" select="getPostReplyByPostNo"/>

    </resultMap>

    <resultMap id="replySelectMap" type="com.example.demo.community.vo.ReplyVO">
        <result property="replyNo"  column="reply_no"   jdbcType="NUMERIC"/>
        <result property="postNo"   column="post_no"    jdbcType="NUMERIC"/>
        <result property="projectNo"    column="project_no"     jdbcType="NUMERIC"/>
        <result property="replyUserId"  column="user_id"        jdbcType="VARCHAR"/>
        <result property="replyContent"     column="reply_content"      jdbcType="VARCHAR"/>
        <result property="regDate"      column="reg_date"       jdbcType="DATE"/>
    </resultMap>

    <resultMap id="getReply" type="com.example.demo.community.vo.ReplyVO">
        <result property="replyNo"  column="reply_no"   jdbcType="NUMERIC"/>
        <result property="postNo"   column="post_no"    jdbcType="NUMERIC"/>
        <result property="projectNo"    column="project_no"     jdbcType="NUMERIC"/>
        <result property="replyContent"     column="reply_content"      jdbcType="VARCHAR"/>
        <result property="regDate"      column="reg_date"       jdbcType="DATE"/>
    </resultMap>

    <insert id="addPost" parameterType="com.example.demo.community.vo.PostVO">
        insert
        into POST(post_no,
                  post_name,
                  post_content,
                  user_Id,
                  reg_date,
                  reply_Cnt,
                  view_Cnt
                  )
        values (SEQ_POST_NO.NEXTVAL,
                #{postName},
                #{postContent},
                #{userId},
                SYSDATE,
                #{replyCnt},
                #{viewCnt})
    </insert>

    <select id="addReply"   parameterType="replyVO">
        insert
        into REPLY(
                   reply_no,
                   post_no,
                   project_no,
                   user_id,
                   reply_content,
                   reg_date
        )
        VALUES (
                SEQ_REPLY_NO.NEXTVAL,
                #{postNo},
                #{projectNo},
                #{replyUserId},
                #{replyContent},
                SYSDATE
               )
    </select>

    <select id="getPost"    parameterType="int"     resultMap="postSelectMap">
        SELECT POST_NO,
                POST_NAME,
                POST_CONTENT,
                USER_ID,
                REG_DATE,
                VIEW_CNT,
                REPLY_CNT

        FROM POST
        WHERE POST_NO = #{postNo}
    </select>

    <select id="getReply"       parameterType="String"      resultMap="getReply">
        SELECT post_no,
               project_no,
               reply_no,
               reply_content,
               reg_date
        FROM REPLY
        WHERE USER_ID = #{replyUserId}
    </select>


    <update id="updatePost"     parameterType="com.example.demo.community.vo.PostVO">
        UPDATE POST
        <set>
            POST_NAME = #{postName},
            POST_CONTENT = #{postContent},
            REG_DATE = #{regDate}

        </set>
        WHERE POST_NO = #{postNo}
    </update>

    <update id="updateReply"    parameterType="replyVO">
        UPDATE REPLY
        <set>
            REPLY_CONTENT = #{replyContent}
        </set>
        WHERE
        reply_NO=#{replyNo}
    </update>

    <delete id="deletePost"     parameterType="postVO">
        DELETE

        FROM POST

        WHERE POST_NO = #{postNo}

    </delete>

    <delete id="deleteReply"    parameterType="com.example.demo.community.vo.ReplyVO">
        DELETE

        FROM REPLY

        WHERE REPLY_NO = #{replyNo}
    </delete>

    <select id="getPostList"    parameterType="searchVO"  resultMap="postSelectMap">
        SELECT *
        FROM (SELECT inner_table.*, ROWNUM as row_seq
            FROM(
                SELECT POST_NO,
                        POST_NAME,
                        POST_CONTENT,
                        USER_ID,
                        REG_DATE,
                        REPLY_CNT,
                        VIEW_CNT
                FROM POST
                <where>
                    <if test="searchConditionA != null">
                        <if test="searchConditionA == 1">
                            POST_NAME Like '%'||#{searchKeyword}||'%'
                        </if>
                        <if test="searchConditionA == 2" >
                            POST_CONTENT LIKE '%'||#{searchKeyword}||'%'
                        </if>
                        <if test="searchConditionA == 3">
                            USER_ID LIKE '%'||#{searchKeyword}||'%'
                        </if>
                    </if>
                </where>
                ORDER BY POST_NO ) inner_table
            WHERE ROWNUM &lt;=#{endRowNum} )
        WHERE row_seq BETWEEN #{startRowNum} AND #{endRowNum}
    </select>

<!--    <select id="getPostList"    parameterType="searchVO"  resultMap="postSelectMap">-->
<!--        SELECT *-->
<!--        FROM (SELECT inner_table.*, ROWNUM as row_seq-->
<!--            FROM(SELECT POST_NO,-->
<!--                        POST_NAME,-->
<!--                        POST_CONTENT,-->
<!--                        USER_ID,-->
<!--                        REG_DATE,-->
<!--                        REPLY_CNT,-->
<!--                        VIEW_CNT-->
<!--                 FROM POST-->
<!--                 <if test="searchConditionA != null">-->
<!--                     <if test="searchConditionA == 1">-->
<!--                         AND POST_NAME = #{searchKeyword}-->
<!--                     </if>-->
<!--                     <if test="searchConditionA == 2" >-->
<!--                         AND POST_CONTENT = #{searchKeyword}-->
<!--                     </if>-->
<!--                     <if test="searchConditionA == 3">-->
<!--                         AND USER_ID = #{searchKeyword}-->
<!--                     </if>-->
<!--                 </if>-->
<!--                 ORDER BY -->
<!--                 <choose>-->
<!--                     <when test="sort == 1">POST_CONTENT DESC</when>-->
<!--                     <when test="sort == 2">POST_CONTENT</when>-->
<!--                     <otherwise>POST_NO</otherwise>-->
<!--                 </choose> POST_NO)inner_table-->
<!--            WHERE ROWNUM &lt;=#{endRowNum} )-->
<!--        WHERE row_seq BETWEEN #{startRowNum} AND #{endRowNum}-->
<!--    </select>-->

<!--    <select id="getPostList"    parameterType="postVO"      resultMap="postSelectMap">-->
<!--        SELECT-->
<!--                POST_NO,-->
<!--                POST_NAME,-->
<!--                USER_ID,-->
<!--                REG_DATE,-->
<!--                REPLY_CNT,-->
<!--                VIEW_CNT-->
<!--        FROM POST-->
<!--    </select>-->





    <select id="getPostReplyByPostNo"   resultType="replyVO">
        select REPLY_NO as replyno,
               USER_ID as replyuserid,
               REPLY_CONTENT as replycontent,
               REG_DATE as reg_date
        FROM REPLY
        WHERE POST_NO = #{postNo}
    </select>

    <select id="getTotalCount"  parameterType="searchVO"    resultType="int">
        SELECT COUNT(*)
        FROM POST
    </select>


</mapper>